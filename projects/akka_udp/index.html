<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Akka actor discovery | Thaqib M</title> <meta name="author" content="Thaqib M"> <meta name="description" content="Local actor discovery in akka &lt;b&gt;typed&lt;/b&gt; using UDP multicasts"> <meta name="keywords" content="thaqib"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%EF%AC%A6&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://thaqibm.github.io/projects/akka_udp/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Thaqib </span>M</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Akka actor discovery</h1> <p class="post-description">Local actor discovery in akka <b>typed</b> using UDP multicasts</p> </header> <article> <p>This post describes how to use Scala and Akka to implement simple actor discovery on local networks using UDP multicasts. I aimed to ensure that the discovery process was both reliable and able to withstand errors. Additionally, I wanted to avoid the issue of <a href="https://en.wikipedia.org/wiki/Split-brain_(computing)" rel="external nofollow noopener" target="_blank">“split brain”</a>, in which the system becomes divided and unable to function properly.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/udp.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="udp multicast" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> UDP Multicast </div> <h1 id="networking-prerequisites">Networking prerequisites</h1> <p>We need some basic networking code to implement the main discovery system.</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">akka.io.Inet.</span><span class="o">{</span><span class="nc">AbstractSocketOptionV2</span><span class="o">,</span> <span class="nc">DatagramChannelCreator</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">java.net.</span><span class="o">{</span><span class="nc">DatagramSocket</span><span class="o">,</span> <span class="nc">Inet4Address</span><span class="o">,</span> <span class="nc">InetAddress</span><span class="o">,</span> <span class="nc">NetworkInterface</span><span class="o">,</span> <span class="nc">StandardProtocolFamily</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">java.nio.channels.DatagramChannel</span>
</code></pre></div></div> <p>To begin, we need to obtain a IPv4 multicast network interface. This idea was inspired by the following code <a href="https://github.com/akka/akka/blob/main/akka-docs/src/test/scala/docs/io/ScalaUdpMulticastSpec.scala#L31" rel="external nofollow noopener" target="_blank">snippet</a>. To do this, we can use the NetworkInterface class from the <code class="language-plaintext highlighter-rouge">java.net package</code> , which represents a Network Interface in the Java environment.</p> <p>Once we have a NetworkInterface object, we can use the getInetAddresses method to obtain a Enumeration of <code class="language-plaintext highlighter-rouge">InetAddress</code> objects, which represent the IP addresses associated with the <code class="language-plaintext highlighter-rouge">NetworkInterface</code>. We can then iterate through this Enumeration and filter out any IP addresses that do not support multicast, using the <code class="language-plaintext highlighter-rouge">isMulticastAddress</code> method of the <code class="language-plaintext highlighter-rouge">InetAddress</code> class.</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ipv4iface</span> <span class="k">=</span> <span class="nv">NetworkInterface</span><span class="o">.</span><span class="py">getNetworkInterfaces</span><span class="o">.</span><span class="py">asScala</span><span class="o">.</span><span class="py">find</span><span class="o">{</span>
    <span class="n">x</span> <span class="k">=&gt;</span> <span class="nv">x</span><span class="o">.</span><span class="py">supportsMulticast</span> <span class="o">&amp;&amp;</span> <span class="nv">x</span><span class="o">.</span><span class="py">isUp</span> <span class="o">&amp;&amp;</span> <span class="nv">x</span><span class="o">.</span><span class="py">getInetAddresses</span><span class="o">.</span><span class="py">asScala</span><span class="o">.</span><span class="py">exists</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">isInstanceOf</span><span class="o">[</span><span class="kt">Inet4Address</span><span class="o">])</span>
<span class="o">}</span>
</code></pre></div></div> <p>Using this <code class="language-plaintext highlighter-rouge">NetworkInterface</code> we can create a <code class="language-plaintext highlighter-rouge">MulticastGroup</code> class that will join a multicast group to begin receiving all datagrams sent to the group.</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">InetProtocolFamily</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">DatagramChannelCreator</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">create</span><span class="o">()</span><span class="k">:</span> <span class="kt">DatagramChannel</span> <span class="o">=</span>
                           <span class="nv">DatagramChannel</span><span class="o">.</span><span class="py">open</span><span class="o">(</span><span class="nv">StandardProtocolFamily</span><span class="o">.</span><span class="py">INET</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">MulticastGroup</span><span class="o">(</span><span class="n">group</span><span class="k">:</span> <span class="kt">InetAddress</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractSocketOptionV2</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">afterBind</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">DatagramSocket</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nv">s</span><span class="o">.</span><span class="py">getChannel</span><span class="o">.</span><span class="py">join</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="o">.</span><span class="py">ipv4iface</span><span class="o">.</span><span class="py">get</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Throwable</span> <span class="o">=&gt;</span> <span class="nv">e</span><span class="o">.</span><span class="py">printStackTrace</span><span class="o">()</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h1 id="singleton-server">Singleton Server</h1> <p>We need to design a server that broadcasts its address using UDP multicast. This server will be implemented as an Akka cluster singleton actor. A singleton actor is a good choice for this server because it serves as a central authority for cluster-wide consistent decisions, such as managing the process of clients joining the cluster. <a href="https://doc.akka.io/docs/akka/current/typed/cluster-singleton.html" rel="external nofollow noopener" target="_blank">More on Akka Cluster Singleton</a></p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">akka.actor.typed._</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.Behaviors</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.adapter._</span>
<span class="k">import</span> <span class="nn">akka.cluster.typed.Cluster</span>
<span class="k">import</span> <span class="nn">akka.event.Logging</span>
<span class="k">import</span> <span class="nn">akka.io.</span><span class="o">{</span><span class="nc">IO</span><span class="o">,</span> <span class="nc">Udp</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">akka.util.ByteString</span>
<span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="n">actor</span> <span class="k">=&gt;</span> <span class="n">classic</span><span class="o">}</span> <span class="c1">// alias for untyped Actor</span>
<span class="k">import</span> <span class="nn">java.net.InetSocketAddress</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration.DurationInt</span>
</code></pre></div></div> <p>In order to interact with the Akka UDP module, we will need to use untyped actors. This is because there is no typed interface available for interacting with Akka UDP. We can use the <a href="https://doc.akka.io/docs/akka/current/stream/actor-interop.html" rel="external nofollow noopener" target="_blank">Actor Sink Pattern</a> to interop with the classic actor.</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">ServerActor</span><span class="o">(</span>
        <span class="n">localInetAddr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">,</span>
        <span class="n">remoteAddr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">,</span>
        <span class="n">sink</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="c1">// Actor sink to forward messages to</span>
    <span class="k">extends</span> <span class="nv">classic</span><span class="o">.</span><span class="py">Actor</span> <span class="k">with</span> <span class="nv">classic</span><span class="o">.</span><span class="py">Timers</span> <span class="o">{</span>

        <span class="k">val</span> <span class="nv">TIMER_KEY</span> <span class="k">=</span> <span class="s">"DISCOVERY"</span>
        <span class="k">val</span> <span class="nv">delay</span> <span class="k">=</span> <span class="mf">5.</span><span class="n">seconds</span>
        <span class="k">import</span> <span class="nn">context._</span>
        <span class="k">val</span> <span class="nv">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">(</span><span class="n">system</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>
        <span class="k">override</span> <span class="k">def</span> <span class="nf">preStart</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
            <span class="nv">super</span><span class="o">.</span><span class="py">preStart</span><span class="o">()</span>
                <span class="k">val</span> <span class="nv">udpManager</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="nc">Udp</span><span class="o">)</span>
                <span class="n">udpManager</span> <span class="o">!</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Bind</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">localInetAddr</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="k">override</span> <span class="k">def</span> <span class="nf">receive</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Bound</span><span class="o">(</span><span class="n">localAddress</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"UDP Bound to ${localAddress}"</span><span class="o">)</span>
                    <span class="k">val</span> <span class="nv">udpConn</span> <span class="k">=</span> <span class="nf">sender</span><span class="o">()</span>
                    <span class="nv">timers</span><span class="o">.</span><span class="py">startTimerWithFixedDelay</span><span class="o">(</span><span class="nc">TIMER_KEY</span><span class="o">,</span> <span class="nc">SendDiscovery</span><span class="o">,</span> <span class="n">delay</span><span class="o">)</span>
                    <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">ready</span><span class="o">(</span><span class="n">udpConn</span><span class="o">))</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">def</span> <span class="nf">ready</span><span class="o">(</span><span class="n">udpConnection</span><span class="k">:</span> <span class="kt">classic.ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span>  <span class="o">={</span>
            <span class="k">case</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Received</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">senderIp</span><span class="o">)</span> <span class="o">=&gt;{</span>
                <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Received ${data} from ${senderIp}"</span><span class="o">)</span>
                    <span class="n">sink</span> <span class="o">!</span> <span class="nv">data</span><span class="o">.</span><span class="py">utf8String</span> <span class="c1">// forward senders akka address to sink </span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="nc">SendDiscovery</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Sending Discovery $SendDiscovery"</span><span class="o">)</span>
                    <span class="k">val</span> <span class="nv">cluster</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">(</span><span class="nv">context</span><span class="o">.</span><span class="py">system</span><span class="o">.</span><span class="py">toTyped</span><span class="o">)</span>
                    <span class="n">udpConnection</span> <span class="o">!</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Send</span><span class="o">(</span><span class="nc">ByteString</span><span class="o">(</span><span class="nv">cluster</span><span class="o">.</span><span class="py">selfMember</span><span class="o">.</span><span class="py">address</span><span class="o">.</span><span class="py">toString</span><span class="o">),</span> <span class="n">remoteAddr</span><span class="o">)</span> <span class="c1">// Send self cluster address to sender</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">b</span><span class="nd">@Udp</span><span class="o">.</span><span class="py">Unbind</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">udpConnection</span> <span class="o">!</span> <span class="n">b</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Unbound</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="nf">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">object</span> <span class="nc">SendDiscovery</span>
<span class="o">}</span>

<span class="c1">// Sink actor</span>

<span class="k">object</span> <span class="nc">ServerActorSink</span> <span class="o">{</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">localInet</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">,</span> <span class="n">multicastAddr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Behaviors</span><span class="o">.</span><span class="py">setup</span><span class="o">{</span> <span class="n">ctx</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="nv">udpServerActor</span> <span class="k">=</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span>
                <span class="nv">classic</span><span class="o">.</span><span class="py">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">ServerActor</span><span class="o">],</span> <span class="n">localInet</span><span class="o">,</span> <span class="n">multicastAddr</span><span class="o">,</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">self</span><span class="o">),</span> <span class="s">"ServerActor"</span><span class="o">)</span>
            <span class="nv">Behaviors</span><span class="o">.</span><span class="py">empty</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h1 id="client-code">Client Code</h1> <p>The client will listen for UDP multicasts until it receives one. When it receives a multicast message, the client will connect to the cluster seed node specified in the message.</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">UdpListenerActor</span><span class="o">(</span><span class="n">localInet</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">,</span>
                                     <span class="n">multicastAddr</span><span class="k">:</span> <span class="kt">InetAddress</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nv">classic</span><span class="o">.</span><span class="py">Actor</span> <span class="k">with</span> <span class="nv">classic</span><span class="o">.</span><span class="py">Timers</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">(</span><span class="nv">context</span><span class="o">.</span><span class="py">system</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">preStart</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nv">super</span><span class="o">.</span><span class="py">preStart</span><span class="o">()</span>
        <span class="k">val</span> <span class="nv">manager</span> <span class="k">=</span> <span class="nc">Udp</span><span class="o">(</span><span class="nv">context</span><span class="o">.</span><span class="py">system</span><span class="o">).</span><span class="py">manager</span>
        <span class="k">val</span> <span class="nv">udpOpts</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="nc">InetProtocolFamily</span><span class="o">(),</span> <span class="nc">MulticastGroup</span><span class="o">(</span><span class="n">multicastAddr</span><span class="o">))</span>
        <span class="n">manager</span> <span class="o">!</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Bind</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">localInet</span><span class="o">,</span> <span class="n">udpOpts</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">override</span> <span class="k">def</span> <span class="nf">receive</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Bound</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">ready</span><span class="o">(</span><span class="nf">sender</span><span class="o">()))</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">private</span> <span class="k">def</span> <span class="nf">ready</span><span class="o">(</span><span class="n">udpRef</span><span class="k">:</span> <span class="kt">classic.ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Received</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">senderIp</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="k">val</span> <span class="nv">dataStr</span> <span class="k">=</span> <span class="nv">data</span><span class="o">.</span><span class="py">utf8String</span>
            <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Connecting to cluster ${dataStr}"</span><span class="o">)</span>
            <span class="n">dataStr</span> <span class="k">match</span> <span class="o">{</span>
                <span class="k">case</span> <span class="nc">AddressFromURIString</span><span class="o">(</span><span class="n">addr</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
                    <span class="k">val</span> <span class="nv">cluster</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">(</span><span class="nv">context</span><span class="o">.</span><span class="py">system</span><span class="o">.</span><span class="py">toTyped</span><span class="o">)</span>
                    <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Received ${dataStr} from $senderIp"</span><span class="o">)</span>
                    <span class="nv">cluster</span><span class="o">.</span><span class="py">manager</span> <span class="o">!</span> <span class="nc">Join</span><span class="o">(</span><span class="n">addr</span><span class="o">)</span> <span class="c1">// Join the server cluster </span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">case</span> <span class="nc">Joined</span> <span class="k">=&gt;</span> <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">joined</span><span class="o">(</span><span class="n">udpRef</span><span class="o">))</span> <span class="c1">// stop</span>
        <span class="k">case</span> <span class="n">b</span><span class="nd">@Udp</span><span class="o">.</span><span class="py">Unbind</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="n">udpRef</span> <span class="o">!</span> <span class="n">b</span>
        <span class="o">}</span>
        <span class="k">case</span> <span class="nv">Udp</span><span class="o">.</span><span class="py">Unbound</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="nv">context</span><span class="o">.</span><span class="py">stop</span><span class="o">(</span><span class="n">self</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">private</span> <span class="k">def</span> <span class="nf">joined</span><span class="o">(</span><span class="n">udpRef</span><span class="k">:</span> <span class="kt">classic.ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Discover</span> <span class="k">=&gt;</span> <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">ready</span><span class="o">(</span><span class="n">udpRef</span><span class="o">))</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Sink Actor</span>

<span class="k">object</span> <span class="nc">DiscoveryClientSink</span> <span class="o">{</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="o">(</span><span class="n">localInet</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">,</span> <span class="n">udpMulticastAddr</span><span class="k">:</span> <span class="kt">InetAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">MemberEvent</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Behaviors</span><span class="o">.</span><span class="py">setup</span><span class="o">{</span> <span class="n">ctx</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="nv">cluster</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">system</span><span class="o">)</span>
        <span class="k">val</span> <span class="nv">selfMember</span> <span class="k">=</span> <span class="nv">cluster</span><span class="o">.</span><span class="py">selfMember</span>
        <span class="k">val</span> <span class="nv">clientDiscoveryActor</span> <span class="k">=</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nv">classic</span><span class="o">.</span><span class="py">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">UdpListenerActor</span><span class="o">],</span> <span class="n">localInet</span><span class="o">,</span> <span class="n">udpMulticastAddr</span><span class="o">),</span> <span class="s">"listener"</span><span class="o">)</span>
        <span class="nv">cluster</span><span class="o">.</span><span class="py">subscriptions</span> <span class="o">!</span> <span class="nc">Subscribe</span><span class="o">(</span><span class="nv">ctx</span><span class="o">.</span><span class="py">self</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">MemberEvent</span><span class="o">])</span>
        <span class="nv">Behaviors</span><span class="o">.</span><span class="py">receiveMessagePartial</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nv">ClusterEvent</span><span class="o">.</span><span class="py">MemberJoined</span><span class="o">(</span><span class="n">member</span><span class="o">)</span> <span class="nf">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="n">selfMember</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">clientDiscoveryActor</span> <span class="o">!</span> <span class="nc">Joined</span> <span class="c1">// Stop discovery again if selfMember joined cluster</span>
                <span class="nv">Behaviors</span><span class="o">.</span><span class="py">same</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="nv">ClusterEvent</span><span class="o">.</span><span class="py">MemberUp</span><span class="o">(</span><span class="n">member</span><span class="o">)</span> <span class="nf">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="n">selfMember</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">clientDiscoveryActor</span> <span class="o">!</span> <span class="nc">Joined</span>
                <span class="nv">Behaviors</span><span class="o">.</span><span class="py">same</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="nv">ClusterEvent</span><span class="o">.</span><span class="py">MemberLeft</span><span class="o">(</span><span class="n">member</span><span class="o">)</span>  <span class="nf">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="n">selfMember</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">clientDiscoveryActor</span> <span class="o">!</span> <span class="nc">Discover</span> <span class="c1">// Start discovery again if selfMember left cluster</span>
                <span class="nv">Behaviors</span><span class="o">.</span><span class="py">same</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="nv">ClusterEvent</span><span class="o">.</span><span class="py">MemberExited</span><span class="o">(</span><span class="n">member</span><span class="o">)</span> <span class="nf">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="n">selfMember</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">clientDiscoveryActor</span> <span class="o">!</span> <span class="nc">Discover</span>  
                <span class="nv">Behaviors</span><span class="o">.</span><span class="py">same</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="nv">ClusterEvent</span><span class="o">.</span><span class="py">MemberDowned</span><span class="o">(</span><span class="n">member</span><span class="o">)</span> <span class="nf">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="n">selfMember</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">clientDiscoveryActor</span> <span class="o">!</span> <span class="nc">Discover</span> 
                <span class="nv">Behaviors</span><span class="o">.</span><span class="py">same</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h1 id="runner-code">Runner Code</h1> <p>We can configure the system to specify which mode it should run in. This allows us to customize the behavior of the system based on the requirements of the service.</p> <div class="language-hocon highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">akka</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="nl">loggers</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"akka.event.slf4j.Slf4jLogger"</span><span class="p">]</span><span class="w">

  </span><span class="c1"># Log level used by the configured loggers (see "loggers") as soon</span><span class="w">
  </span><span class="c1"># as they have been started; before that, see "stdout-loglevel"</span><span class="w">
  </span><span class="c1"># Options: OFF, ERROR, WARNING, INFO, DEBUG</span><span class="w">
  </span><span class="nl">loglevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"ERROR"</span><span class="w">

  </span><span class="c1"># Log level for the very basic logger activated during ActorSystem startup.</span><span class="w">
  </span><span class="c1"># This logger prints the log messages to stdout (System.out).</span><span class="w">
  </span><span class="c1"># Options: OFF, ERROR, WARNING, INFO, DEBUG</span><span class="w">
  </span><span class="nl">stdout-loglevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"ERROR"</span><span class="w">
  </span><span class="nl">actor</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">provider</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="l">cluster</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nl">remote</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">artery</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="l">on</span><span class="w">
      </span><span class="nl">transport</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="l">tcp</span><span class="w">
      </span><span class="nl">canonical.hostname</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"0.0.0.0"</span><span class="w">
      </span><span class="nl">canonical.port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2554</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">

  </span><span class="nl">cluster</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># auto downing is NOT safe for production deployments.</span><span class="w">
    </span><span class="c1"># you may want to use it during development, read more about it in the docs.</span><span class="w">
    </span><span class="nl">auto-down-unreachable-after</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="l">s</span><span class="w">
    </span><span class="nl">min-nr-of-members</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># Enable metrics extension in akka-cluster-metrics.</span><span class="w">
</span><span class="nl">akka.extensions</span><span class="p">=[</span><span class="s2">"akka.cluster.metrics.ClusterMetricsExtension"</span><span class="p">]</span><span class="w">

</span><span class="c1"># Sigar native library extract location during tests.</span><span class="w">
</span><span class="c1"># Note: use per-jvm-instance folder when running multiple jvm on one host.</span><span class="w">
</span><span class="nl">akka.cluster.metrics.native-library-extract-folder</span><span class="p">=</span><span class="si">${</span><span class="nv">user.dir</span><span class="si">}</span><span class="l">/target/native</span><span class="w">
</span><span class="nl">akka.actor.allow-java-serialization</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="l">on</span><span class="w">

</span><span class="nl">udp-multicast-address</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"239.255.100.100"</span><span class="w"> </span><span class="c1"># Multicast address to listen to</span><span class="w">
</span><span class="nl">udp-multicast-port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">9443</span><span class="w">
</span><span class="nl">system-name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"sys"</span><span class="w">
</span><span class="nl">mode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"client"</span><span class="w"> </span><span class="c1"># Mode client or server</span><span class="w">
</span><span class="nl">singleton-key</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"singleton-key"</span><span class="w"> </span><span class="c1"># name for singleton actor</span><span class="w">
</span></code></pre></div></div> <p>Then in <code class="language-plaintext highlighter-rouge">Main.scala</code> we have</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.typesafe.config.</span><span class="o">{</span><span class="nc">Config</span><span class="o">,</span> <span class="nc">ConfigFactory</span><span class="o">,</span> <span class="nc">ConfigValueFactory</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="n">actor</span> <span class="k">=&gt;</span> <span class="n">classic</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">Main</span> <span class="k">extends</span> <span class="nc">App</span><span class="o">{</span>
    <span class="k">val</span> <span class="nv">ipaddr</span> <span class="k">=</span> <span class="s">"X.X.X.X"</span> <span class="c1">// get host local ip address </span>

    <span class="k">val</span> <span class="nv">config</span><span class="k">:</span> <span class="kt">Config</span> <span class="o">=</span> <span class="nv">ConfigFactory</span><span class="o">.</span><span class="py">load</span><span class="o">(</span><span class="s">"config"</span><span class="o">).</span><span class="py">withValue</span><span class="o">(</span>
        <span class="s">"akka.remote.artery.canonical.hostname"</span><span class="o">,</span>
        <span class="nv">ConfigValueFactory</span><span class="o">.</span><span class="py">fromAnyRef</span><span class="o">(</span><span class="n">ipaddr</span><span class="o">)</span>
    <span class="o">)</span>

    <span class="k">val</span> <span class="nv">sysName</span> <span class="k">=</span> <span class="nv">config</span><span class="o">.</span><span class="py">getString</span><span class="o">(</span><span class="s">"system-name"</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">sys</span> <span class="k">=</span> <span class="nv">classic</span><span class="o">.</span><span class="py">ActorSystem</span><span class="o">(</span><span class="n">sysName</span><span class="o">,</span> <span class="n">config</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">mode</span> <span class="k">=</span> <span class="nv">config</span><span class="o">.</span><span class="py">getString</span><span class="o">(</span><span class="s">"mode"</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">port</span> <span class="k">=</span> <span class="nv">config</span><span class="o">.</span><span class="py">getInt</span><span class="o">(</span><span class="s">"udp-multicast-port"</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">multicastStr</span> <span class="k">=</span> <span class="nv">config</span><span class="o">.</span><span class="py">getString</span><span class="o">(</span><span class="s">"udp-multicast-address"</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">localInet</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">multicastAddr</span> <span class="k">=</span> <span class="nv">InetAddress</span><span class="o">.</span><span class="py">getByName</span><span class="o">(</span><span class="n">multicastStr</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">remoteInet</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span>
            <span class="nv">InetAddress</span><span class="o">.</span><span class="py">getByName</span><span class="o">(</span><span class="nv">config</span><span class="o">.</span><span class="py">getString</span><span class="o">(</span><span class="s">"udp-multicast-address"</span><span class="o">)),</span>
            <span class="nv">config</span><span class="o">.</span><span class="py">getInt</span><span class="o">(</span><span class="s">"udp-multicast-port"</span><span class="o">)</span>
            <span class="o">)</span>

    <span class="k">val</span> <span class="nv">singletonKey</span> <span class="k">=</span> <span class="nv">config</span><span class="o">.</span><span class="py">getString</span><span class="o">(</span><span class="s">"singleton-key"</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">cluster</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">(</span><span class="nv">sys</span><span class="o">.</span><span class="py">toTyped</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">singletonManager</span> <span class="k">=</span> <span class="nc">ClusterSingleton</span><span class="o">(</span><span class="nv">sys</span><span class="o">.</span><span class="py">toTyped</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">singletonProxy</span> <span class="k">=</span> <span class="nv">singletonManager</span><span class="o">.</span><span class="py">init</span><span class="o">(</span>
            <span class="nc">SingletonActor</span><span class="o">(</span>
                <span class="nv">Behaviors</span><span class="o">.</span><span class="py">supervise</span><span class="o">(</span><span class="nc">ServerActorSink</span><span class="o">(</span><span class="n">localInet</span><span class="o">,</span> <span class="n">remoteInet</span><span class="o">))</span>
                <span class="o">.</span><span class="py">onFailure</span><span class="o">(</span><span class="nv">SupervisorStrategy</span><span class="o">.</span><span class="py">restart</span><span class="o">),</span> 
                <span class="n">singletonKey</span>
                <span class="o">)</span>
            <span class="o">)</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">"server"</span><span class="o">){</span>
        <span class="nf">println</span><span class="o">(</span><span class="s">"Starting in server mode creating cluster ..."</span><span class="o">)</span>
            <span class="nv">cluster</span><span class="o">.</span><span class="py">manager</span> <span class="o">!</span> <span class="nc">JoinSeedNodes</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="nv">cluster</span><span class="o">.</span><span class="py">selfMember</span><span class="o">.</span><span class="py">address</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="k">else</span><span class="o">{</span>
        <span class="nf">println</span><span class="o">(</span><span class="s">"Starting in client mode"</span><span class="o">)</span>
            <span class="nv">sys</span><span class="o">.</span><span class="py">spawn</span><span class="o">(</span><span class="nc">DiscoveryClientSink</span><span class="o">(</span><span class="n">localInet</span><span class="o">,</span> <span class="n">multicastAddr</span><span class="o">),</span> <span class="s">"client_actor"</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>The Akka singleton feature ensures that if a singleton actor goes down, the oldest node in the cluster will automatically spawn a new singleton server to take its place. This helps to prevent a single point of failure and ensures that the system remains available even if the original singleton actor fails. This helps to maintain the availability and reliability of the system.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Thaqib M. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>